<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shorts</title>

  <!-- Reference your site-wide stylesheet (adjust if your site is served from a subfolder) -->
  <!-- If your site root is the repo root on GitHub Pages (user.github.io/repo/), use: /repo/styles.css -->
  <link rel="stylesheet" href="../styles.css">

  <style>
    /* Minimal fallbacks; your styles.css will override */
    body { font-family: system-ui, sans-serif; margin: 0; background: #0b0b0c; color: #e8e8ea; }
    header { max-width: 900px; margin: 24px auto; padding: 0 16px; }
    h1 { font-size: 1.6rem; margin: 0 0 8px; }
    p.lede { opacity: .8; margin: 0 0 16px; }

    .list { max-width: 900px; margin: 0 auto 64px; padding: 0 16px; display: grid; gap: 12px; }
    details { background: #141416; border: 1px solid #232327; border-radius: 14px; }
    summary { cursor: pointer; padding: 14px 16px; list-style: none; display: flex; align-items: baseline; gap: 10px; }
    summary::-webkit-details-marker { display: none }
    .title { font-weight: 600; }
    .date { font: 12px/1.2 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; opacity: .7; margin-left: auto; }
    .content { padding: 0 16px 16px; }
    .content pre { background: #0e0e11; padding: 12px; border-radius: 10px; overflow:auto; border:1px solid #232327 }
    .content a { color: #7ab7ff }
    .empty { opacity:.7; font-style: italic; padding: 24px; text-align: center; }
    .search { max-width: 900px; margin: 0 auto 12px; padding: 0 16px; }
    .search input { width: 100%; border-radius: 12px; background: #141416; border:1px solid #232327; color:#e8e8ea; padding: 10px 12px; }
  </style>
</head>
<body>
  <header>
    <h1>Shorts</h1>
    <p class="lede">Quick notes & fragments, sorted by last update. Click to expand.</p>
  </header>

  <div class="search"><input id="q" placeholder="Filter by title or contentâ€¦" aria-label="Filter"></div>
  <div class="list" id="list" role="list"></div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
  // Clean Obsidian wikilinks before parsing:
  // [[Page|Alias]] -> Alias; [[Page#Section]] -> Page; ![[embed]] -> removed
  function cleanObsidian(md){
    md = md.replace(/!\[\[[^\]]*\]\]/g, '');                           // remove embeds
    md = md.replace(/\[\[[^\]|#]+(?:#[^\]|]+)?\|([^\]]+)\]\]/g, '$1');  // alias form
    md = md.replace(/\[\[([^\]|#]+)(?:#[^\]]+)?\]\]/g, '$1');           // simple form
    return md;
  }

  async function fetchJSON(url){
    const u = new URL(url, location.href);
    u.searchParams.set('_', Date.now());
    const r = await fetch(u, {cache:'no-store'});
    if(!r.ok) throw new Error('Failed to load '+url);
    return r.json();
  }

  async function loadMD(item, container){
    if(container.dataset.loaded) return;
    const r = await fetch(item.path, {cache:'no-store'});
    let md = await r.text();
    md = cleanObsidian(md);
    container.innerHTML = marked.parse(md);
    container.dataset.loaded = '1';
  }

  function wireSearch(){
    const input = document.querySelector('#q');
    input.addEventListener('input', () => {
      const term = input.value.trim().toLowerCase();
      for(const el of document.querySelectorAll('details[data-title]')){
        const title = el.dataset.title;
        const body = el.querySelector('.content').textContent.toLowerCase();
        const hit = !term || title.includes(term) || body.includes(term);
        el.style.display = hit ? '' : 'none';
      }
    });
  }

  (async function init(){
    const list = document.getElementById('list');
    try {
      const m = await fetchJSON('manifest.json');
      const items = (m.items || []).slice().sort((a,b)=> (a.modified<b.modified?1:-1));
      if(!items.length){ list.innerHTML = '<div class="empty">No shorts yet.</div>'; return; }

      for(const item of items){
        const d = new Date(item.modified || Date.now());
        const el = document.createElement('details');
        el.setAttribute('role','listitem');
        el.dataset.title = (item.title||'').toLowerCase();
        el.innerHTML = `
          <summary>
            <span class="title">${item.title || item.slug}</span>
            <span class="date" title="Last modified">${d.toLocaleString([], {year:'numeric', month:'short', day:'2-digit'})}</span>
          </summary>
          <div class="content"></div>
        `;
        const content = el.querySelector('.content');
        el.addEventListener('toggle', () => { if(el.open) loadMD(item, content); });
        list.appendChild(el);
      }

      wireSearch();
    } catch (e) {
      console.error(e);
      list.innerHTML = '<div class="empty">Could not load manifest.json.</div>';
    }
  })();
  </script>
</body>
</html>
